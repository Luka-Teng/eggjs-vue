<template lang="jade">
  div
    div(class="w3-container w3-teal")
      h2 Upload Pictures
    div(class="w3-container w3-card-4 w3-padding-bottom")
      div(class="w3-row")
        div(class="w3-col s3 w3-padding-medium" v-for="tag in tags")
          <input class="w3-radio" type="radio" name="tags" :value="tag" v-model="selected_tag">
          <label class="w3-validate">{{tag}}</label>
      div(class="w3-row w3-section-12 w3-padding-left")
        div(id="drag-content" v-bind:class="[drag_area_class]")
          div(class="drag-icon") +
        div(style="float: left;width: calc(100% - 550px);text-align: center;margin-top: 65px;")
          <a class="w3-btn w3-xxlarge w3-teal" @click="upload">UPLOAD</a>
      div(class="w3-row")
        div(class="w3-col s3 w3-padding")
          transition-group(name="fade")
            div(class="img-wrapper relative w3-col w3-round w3-border w3-margin-bottom" v-for="image in images_col_1" v-bind:key="image.id")
              img(v-bind:src="image.src" class="img-responsive" @click="modal.show(image.src)")
              <a class="w3-btn w3-tiny w3-red drag-delete" @click="onDelete(image.id)">DELETE</a>
        div(class="w3-col s3 w3-padding")
          transition-group(name="fade")
            div(class="img-wrapper relative w3-col w3-round w3-border w3-margin-bottom" v-for="image in images_col_2" v-bind:key="image.id")
              img(v-bind:src="image.src" class="img-responsive" @click="modal.show(image.src)")
              <a class="w3-btn w3-tiny w3-red drag-delete" @click="onDelete(image.id)">DELETE</a>
        div(class="w3-col s3 w3-padding")
          transition-group(name="fade")
            div(class="img-wrapper relative w3-col w3-round w3-border w3-margin-bottom" v-for="image in images_col_3" v-bind:key="image.id")
              img(v-bind:src="image.src" class="img-responsive" @click="modal.show(image.src)")
              <a class="w3-btn w3-tiny w3-red drag-delete" @click="onDelete(image.id)">DELETE</a>
        div(class="w3-col s3 w3-padding")
          transition-group(name="fade")
            div(class="img-wrapper relative w3-col w3-round w3-border w3-margin-bottom" v-for="image in images_col_4" v-bind:key="image.id")
              img(v-bind:src="image.src" class="img-responsive" @click="modal.show(image.src)")
              <a class="w3-btn w3-tiny w3-red drag-delete" @click="onDelete(image.id)">DELETE</a>
</template>

<script>
// 引入vuex
import {mapGetters, mapActions} from 'vuex'
// 文件拖拽包
import DragFiles from '@/utils/dragFiles'
// 图片展示
import {ShowImage} from '@/utils/tools'

export default {
  data () {
    return {
      // 图片的64进制码
      images: [],
      // 需要上传的formData
      files: [],
      drag_area_class: '',
      selected_tag: 'default',
      modal: new ShowImage()
    }
  },
  computed: {
    ...mapGetters({
      tags: 'tags'
    }),
    images_col_1 () {
      return this.images.filter((image, index) => {
        return index % 4 === 0
      })
    },
    images_col_2 () {
      return this.images.filter((image, index) => {
        return index % 4 === 1
      })
    },
    images_col_3 () {
      return this.images.filter((image, index) => {
        return index % 4 === 2
      })
    },
    images_col_4 () {
      return this.images.filter((image, index) => {
        return index % 4 === 3
      })
    }
  },
  methods: {
    ...mapActions({
      uploadPictures: 'uploadPictures',
      getTags: 'getTags',
      setLoading: 'setLoading',
      setFlash: 'setFlash'
    }),
    onDelete (id) {
      this.images.forEach((image, index) => {
        if (image.id === id) {
          this.images.splice(index, 1)
        }
      })
      this.files.forEach((file, index) => {
        if (file.id === id) {
          this.files.splice(index, 1)
        }
      })
    },
    upload () {
      const formData = new FormData()
      formData.append('tag_name', this.selected_tag)
      this.files.forEach((file) => {
        formData.append(file.name, file.file)
      })
      this.uploadPictures(formData).then((data) => {
        if (data.status === 'success') {
          this.files = []
          this.images = []
        }
      })
    }
  },
  created () {
    this.getTags()
  },
  mounted () {
    const dragField = new DragFiles({
      id: 'drag-content',
      max_files: 20
    })
    dragField.onDragOver((target) => {
      this.drag_area_class = 'in'
    })
    dragField.onDragLeave((target) => {
      this.drag_area_class = 'out'
    })
    dragField.onDrop((target, data) => {
      // target指向的#drag-content
      this.drag_area_class = 'out'
      if (data.status === 'failed') {
        this.setFlash(data.msg)
      } else {
        data.data.forEach((file) => {
          // 把拖拽的文件加入总文件
          const id = this.files.length
          this.files.push({
            id: id,
            name: file.name,
            file: file.file
          })
          // 将数据存储为base64
          const fileReader = new FileReader()
          fileReader.addEventListener('load', () => {
            this.images.push({
              src: fileReader.result,
              id: id
            })
          })
          fileReader.readAsDataURL(file.file)
        })
      }
    })
  }
}
</script>

<style lang="stylus">
#drag-content
  width 550px
  height 225px
  border-radius 5px
  border 1px solid #aaa
  background #eee
  color #888
  float left

#drag-content.in
  box-shadow 0px 0px 5px 3px rgba(0,0,0,0.2)
  background-color #ddd
  color #eee

#drag-content > .drag-icon
  font-size 116px
  text-align center

.img-wrapper
  .drag-delete
    position absolute
    right 0px
    bottom 0px
    display none
  &:hover
    .drag-delete
      display block

.fade-enter-active
.fade-leave-active
  transition: opacity .5s
  transition: all .5s

.fade-enter
.fade-leave-to
  opacity: 0
  transform: translateY(30px)

</style>
